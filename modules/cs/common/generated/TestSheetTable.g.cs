// <auto-generated>
// DO NOT EDIT - Generated by Devian Build System
// </auto-generated>

using System;
using System.Collections.Generic;
using System.Text;
using Devian.Core;
using Google.Protobuf;

namespace Devian.Common
{
    /// <summary>
    /// TestSheet 테이블 컨테이너.
    /// </summary>
    public sealed class TB_TestSheet : ITableContainer
    {
        private readonly Dictionary<int, TestSheetRow> _map = new();
        private readonly List<TestSheetRow> _rows = new();

        public IReadOnlyList<TestSheetRow> Rows => _rows;
        public int Count => _rows.Count;

        public TestSheetRow? Get(int key) => _map.TryGetValue(key, out var row) ? row : null;
        public bool TryGet(int key, out TestSheetRow? row) => _map.TryGetValue(key, out row);
        public TestSheetRow this[int key] => _map[key];
        public bool ContainsKey(int key) => _map.ContainsKey(key);

        /// <inheritdoc/>
        public void Clear()
        {
            _map.Clear();
            _rows.Clear();
        }

        /// <inheritdoc/>
        public void LoadFromJson(string json, LoadMode mode = LoadMode.Merge)
        {
            if (mode == LoadMode.Replace) Clear();

            var parser = new JsonParser(JsonParser.Settings.Default);
            var lines = json.Split('\n', StringSplitOptions.RemoveEmptyEntries);
            foreach (var line in lines)
            {
                if (string.IsNullOrWhiteSpace(line)) continue;

                var msg = parser.Parse<Proto.TestSheetRow>(line);
                var row = new TestSheetRow();
                row._LoadProto(msg);

                var key = row.Number;
                if (_map.ContainsKey(key))
                {
                    var idx = _rows.FindIndex(r => r.GetKey()!.Equals(key));
                    if (idx >= 0) _rows[idx] = row;
                }
                else
                {
                    _rows.Add(row);
                }
                _map[key] = row;
            }
        }

        /// <inheritdoc/>
        public string SaveToJson()
        {
            var sb = new StringBuilder();
            var formatter = new JsonFormatter(JsonFormatter.Settings.Default);

            foreach (var row in _rows)
            {
                var proto = row._SaveProto();
                sb.AppendLine(formatter.Format(proto));
            }

            return sb.ToString();
        }

        /// <inheritdoc/>
        public void LoadFromBase64(string base64, LoadMode mode = LoadMode.Merge)
        {
            if (mode == LoadMode.Replace) Clear();

            var bytes = Convert.FromBase64String(base64);
            var rows = Bootstrap._Decode_TestSheet(bytes);
            foreach (var row in rows)
            {
                var key = row.Number;
                if (_map.ContainsKey(key))
                {
                    var idx = _rows.FindIndex(r => r.GetKey()!.Equals(key));
                    if (idx >= 0) _rows[idx] = row;
                }
                else
                {
                    _rows.Add(row);
                }
                _map[key] = row;
            }
        }

        /// <inheritdoc/>
        public string SaveToBase64()
        {
            var bytes = Bootstrap._Encode_TestSheet(_rows);
            return Convert.ToBase64String(bytes);
        }
    }
}
