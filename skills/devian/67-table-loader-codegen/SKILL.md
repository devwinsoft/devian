# Devian – 67 Table Loader Codegen

## Purpose

**61-tablegen이 생성한 sheet 단위 meta를 읽어서, Unity에서 바로 쓰는 C# 컨테이너 코드를 생성한다.**

---

## Belongs To

**Consumer / Tooling (Build tool)**

---

## 공통 핵심 원칙 (최우선)

| # | 원칙 |
|---|------|
| 1 | **Devian은 비즈니스 로직을 다루지 않는다** |
| 2 | **sub-domain / language / region / shard 개념을 해석하지 않는다** |
| 3 | **테이블 종류 1개당 컨테이너는 정확히 1개** |
| 4 | **분할 데이터는 "여러 번 Load"로 합쳐진다** |

---

## LoadMode 정책 (핵심)

### LoadMode 정의

```csharp
public enum LoadMode
{
    Merge,      // 기본값
    Replace
}
```

### 동작

| Mode | 설명 |
|------|------|
| **Merge** (기본) | 기존 캐시 유지 + 새 데이터 병합. key 충돌 시 overwrite |
| **Replace** | 기존 캐시 Clear 후 로드 |

---

## 출력

### 파일 생성 규칙

| 출력 | 경로 |
|------|------|
| **Table 컨테이너** | `Table.{ExcelFileName}.g.cs` |

---

## 생성 구조

```csharp
namespace Devian.Tables
{
    public static partial class Table
    {
        public static class T_{TableName}
        {
            // ...
        }
    }
}
```

---

## Table 컨테이너 생성 규칙

### 필수 API

| API | 설명 |
|-----|------|
| `bool IsLoaded { get; }` | 로드 여부 |
| `void LoadFromJson(string json, LoadMode mode = LoadMode.Merge)` | JSON 로드 |
| `TRow Get(TKey key)` | 키로 조회 (없으면 예외) |
| `bool TryGet(TKey key, out TRow row)` | 키로 조회 (없으면 false) |
| `void Unload()` | 캐시 제거 |

### LoadFromJson 구현 규칙

```csharp
public static void LoadFromJson(string jsonArrayText, LoadMode mode = LoadMode.Merge)
{
    if (mode == LoadMode.Replace)
    {
        _byKey?.Clear();
    }
    
    _byKey ??= new Dictionary<TKey, TRow>();
    
    var rows = JsonSerializer.Deserialize<TRow[]>(jsonArrayText)
        ?? throw new InvalidOperationException("Failed to deserialize JSON.");

    foreach (var row in rows)
    {
        // Merge: key 충돌 시 overwrite
        _byKey[row.{KeyField}] = row;
    }
}
```

---

## ExcelFile 단위 Load/Unload 함수

```csharp
public static void LoadFile_{ExcelFileName}(ILoaderTextJson loader)
{
    T_{TableName1}.LoadFromJson(loader.Load("{sheetKey1}"));
    T_{TableName2}.LoadFromJson(loader.Load("{sheetKey2}"));
}

public static void UnloadFile_{ExcelFileName}()
{
    T_{TableName1}.Unload();
    T_{TableName2}.Unload();
}
```

- **LoadMode는 기본값(Merge) 사용**
- `{sheetKey}`는 sheetName 정규화 문자열
- loader 구현은 Devian 책임 아님

---

## 금지 사항 (MUST NOT)

| # | 금지 |
|---|------|
| 1 | **sub-domain 기반 컨테이너 생성 금지** |
| 2 | **runtime 파라미터 기반 멀티 캐시 구조 금지** |
| 3 | **ref 처리 로직 생성 금지** |

---

## 생성 코드 예시

```csharp
// <auto-generated/>
#nullable enable

namespace Devian.Tables
{
    public static partial class Table
    {
        public static void LoadFile_GameData(ILoaderTextJson loader)
        {
            T_Items.LoadFromJson(loader.Load("items"));
            T_Weapons.LoadFromJson(loader.Load("weapons"));
        }
        
        public static void UnloadFile_GameData()
        {
            T_Items.Unload();
            T_Weapons.Unload();
        }
        
        public static class T_Items
        {
            private static Dictionary<int, ItemsRow>? _byKey;
            
            public static bool IsLoaded => _byKey != null && _byKey.Count > 0;

            public static void LoadFromJson(string jsonArrayText, LoadMode mode = LoadMode.Merge)
            {
                if (mode == LoadMode.Replace)
                {
                    _byKey?.Clear();
                }
                
                _byKey ??= new Dictionary<int, ItemsRow>();
                
                var rows = System.Text.Json.JsonSerializer.Deserialize<ItemsRow[]>(jsonArrayText)
                    ?? throw new System.InvalidOperationException("Failed to deserialize JSON.");

                foreach (var row in rows)
                {
                    _byKey[row.Id] = row;  // Merge: overwrite on conflict
                }
            }

            public static ItemsRow Get(int key)
            {
                if (_byKey == null)
                    throw new System.InvalidOperationException("T_Items is not loaded.");
                return _byKey[key];
            }

            public static bool TryGet(int key, out ItemsRow? row)
            {
                if (_byKey == null)
                {
                    row = null;
                    return false;
                }
                return _byKey.TryGetValue(key, out row);
            }

            public static void Unload()
            {
                _byKey = null;
            }
        }
    }
}
```

---

## Acceptance Criteria

| # | 조건 |
|---|------|
| 1 | ExcelFileName마다 `Table.{ExcelFileName}.g.cs` 생성 |
| 2 | **LoadFromJson에 LoadMode 파라미터 (기본 Merge)** |
| 3 | **Merge: 기존 캐시 유지, key 충돌 시 overwrite** |
| 4 | **Replace: Clear 후 로드** |
| 5 | **sub-domain 기반 컨테이너 생성 금지** |
| 6 | ref 발견 시 빌드 실패 |

---

## Related Skills

| Skill | 관계 |
|-------|------|
| `61-tablegen-implementation` | meta 생성 |
| `65-table-loader-implementation` | 런타임 사용법 |

---

## Version History

| Version | Date | Changes |
|---------|------|---------|
| 0.6.0 | 2024-12-25 | **LoadMode 정책 추가**, sub-domain 금지 명시 |
| 0.5.0 | 2024-12-25 | primaryKeyFieldName/TypeKey 사용 |
| 0.4.0 | 2024-12-21 | Key=1열, comment 미포함 |
| 0.1.0 | 2024-12-21 | Initial skill definition |
