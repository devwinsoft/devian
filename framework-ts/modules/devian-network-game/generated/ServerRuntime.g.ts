// <auto-generated>
// DO NOT EDIT - Generated by Devian Build System v10
// This file provides server-side runtime for protocol group: Game
// </auto-generated>

import type { INetworkRuntime, SendFn, ICodec, UnknownOpcodeEvent } from '@devian/network';
import { C2Game } from '../C2Game.g';
import { Game2C } from '../Game2C.g';

/** Unknown opcode handler type */
export type UnknownOpcodeHandler = (event: UnknownOpcodeEvent) => void | Promise<void>;

/**
 * Server Runtime for Game protocol group
 * 
 * - Inbound: C2Game (client → server)
 * - Outbound: Game2C (server → client)
 */
export class NetworkServerRuntime implements INetworkRuntime {
    private readonly stub: C2Game.Stub;
    private readonly codec: ICodec;
    private unknownHandler: UnknownOpcodeHandler | null = null;

    constructor(codec: ICodec) {
        this.codec = codec;
        this.stub = new C2Game.Stub(codec);
    }

    /**
     * Get inbound stub for handler registration
     */
    getStub(): C2Game.Stub {
        return this.stub;
    }

    getInboundOpcodeName(opcode: number): string | null {
        return C2Game.getOpcodeName(opcode) ?? null;
    }

    async dispatchInbound(sessionId: number, opcode: number, payload: Uint8Array): Promise<void> {
        await this.stub.dispatch(sessionId, opcode, payload);
    }

    createOutboundProxy(sendFn: SendFn): Game2C.Proxy {
        return new Game2C.Proxy(sendFn, this.codec);
    }

    /**
     * Set handler for unknown inbound opcodes.
     * @param handler Handler function (async supported)
     */
    setUnknownInboundOpcode(handler: UnknownOpcodeHandler): void {
        this.unknownHandler = handler;
    }

    /**
     * Handle unknown inbound opcode.
     * Called by NetworkServer when opcode is not recognized.
     * Exceptions are caught and logged, never propagated.
     */
    async handleUnknownInboundOpcode(event: UnknownOpcodeEvent): Promise<void> {
        try {
            if (this.unknownHandler) {
                await this.unknownHandler(event);
            } else {
                console.warn(
                    `[NetworkServerRuntime] Unknown opcode ${event.opcode} from session ${event.sessionId} (${event.payload.length} bytes)`
                );
            }
        } catch (err) {
            console.error(`[NetworkServerRuntime] unknown handler failed`, err);
        }
    }
}

/**
 * Create server runtime for Game protocol group
 */
export function createServerRuntime(codec: ICodec): NetworkServerRuntime {
    return new NetworkServerRuntime(codec);
}

/** Re-export types for convenience */
export { C2Game, Game2C };