// <auto-generated>
// DO NOT EDIT - Generated by Devian Build System v10
// This file provides client-side runtime for protocol group: Game
// </auto-generated>

import type { INetworkRuntime, SendFn, ICodec, UnknownOpcodeEvent } from '@devian/core';
import { Game2C } from '../Game2C.g';
import { C2Game } from '../C2Game.g';

/** Unknown opcode handler type */
export type UnknownOpcodeHandler = (event: UnknownOpcodeEvent) => void | Promise<void>;

/**
 * Client Runtime for Game protocol group
 * 
 * - Inbound: Game2C (server → client)
 * - Outbound: C2Game (client → server)
 */
export class NetworkClientRuntime implements INetworkRuntime {
    private readonly stub: Game2C.Stub;
    private readonly codec: ICodec;
    private unknownHandler: UnknownOpcodeHandler | null = null;

    constructor(codec: ICodec) {
        this.codec = codec;
        this.stub = new Game2C.Stub(codec);
    }

    /**
     * Get inbound stub for handler registration
     */
    getStub(): Game2C.Stub {
        return this.stub;
    }

    getInboundOpcodeName(opcode: number): string | null {
        return Game2C.getOpcodeName(opcode) ?? null;
    }

    async dispatchInbound(sessionId: number, opcode: number, payload: Uint8Array): Promise<void> {
        await this.stub.dispatch(sessionId, opcode, payload);
    }

    createOutboundProxy(sendFn: SendFn): C2Game.Proxy {
        return new C2Game.Proxy(sendFn, this.codec);
    }

    /**
     * Set handler for unknown inbound opcodes.
     * @param handler Handler function (async supported)
     */
    setUnknownInboundOpcode(handler: UnknownOpcodeHandler): void {
        this.unknownHandler = handler;
    }

    /**
     * Handle unknown inbound opcode.
     * Called by NetworkClient when opcode is not recognized.
     * Exceptions are caught and logged, never propagated.
     */
    async handleUnknownInboundOpcode(event: UnknownOpcodeEvent): Promise<void> {
        try {
            if (this.unknownHandler) {
                await this.unknownHandler(event);
            } else {
                console.warn(
                    `[NetworkClientRuntime] Unknown opcode ${event.opcode} (${event.payload.length} bytes)`
                );
            }
        } catch (err) {
            console.error(`[NetworkClientRuntime] unknown handler failed`, err);
        }
    }
}

/**
 * Create client runtime for Game protocol group
 * @returns Runtime instance with stub access and proxy factory
 */
export function createClientRuntime(codec: ICodec): {
    runtime: NetworkClientRuntime;
    game2CStub: Game2C.Stub;
    c2GameProxyFactory: (sendFn: SendFn) => C2Game.Proxy;
} {
    const runtime = new NetworkClientRuntime(codec);
    return {
        runtime,
        game2CStub: runtime.getStub(),
        c2GameProxyFactory: (sendFn) => runtime.createOutboundProxy(sendFn),
    };
}

/** Re-export types for convenience */
export { Game2C, C2Game };