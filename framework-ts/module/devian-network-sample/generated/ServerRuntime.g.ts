// <auto-generated>
// DO NOT EDIT - Generated by Devian Build System v10
// This file provides server-side runtime for protocol group: Sample
// </auto-generated>

import type { INetworkRuntime, SendFn, ICodec, UnknownOpcodeEvent } from '@devian/core';
import { C2Sample } from '../C2Sample.g';
import { Sample2C } from '../Sample2C.g';

/** Unknown opcode handler type */
export type UnknownOpcodeHandler = (event: UnknownOpcodeEvent) => void | Promise<void>;

/**
 * Server Runtime for Sample protocol group
 * 
 * - Inbound: C2Sample (client → server)
 * - Outbound: Sample2C (server → client)
 */
export class NetworkServerRuntime implements INetworkRuntime {
    private readonly stub: C2Sample.Stub;
    private readonly codec: ICodec | null;
    private unknownHandler: UnknownOpcodeHandler | null = null;

    constructor(codec?: ICodec) {
        this.codec = codec ?? null;
        this.stub = this.codec ? new C2Sample.Stub(this.codec) : new C2Sample.Stub();
    }

    /**
     * Get inbound stub for handler registration
     */
    getStub(): C2Sample.Stub {
        return this.stub;
    }

    getInboundOpcodeName(opcode: number): string | null {
        return C2Sample.getOpcodeName(opcode) ?? null;
    }

    async dispatchInbound(sessionId: number, opcode: number, payload: Uint8Array): Promise<void> {
        await this.stub.dispatch(sessionId, opcode, payload);
    }

    createOutboundProxy(sendFn: SendFn): Sample2C.Proxy {
        return this.codec ? new Sample2C.Proxy(sendFn, this.codec) : new Sample2C.Proxy(sendFn);
    }

    /**
     * Set handler for unknown inbound opcodes.
     * @param handler Handler function (async supported)
     */
    setUnknownInboundOpcode(handler: UnknownOpcodeHandler): void {
        this.unknownHandler = handler;
    }

    /**
     * Handle unknown inbound opcode.
     * Called by NetworkServer when opcode is not recognized.
     * Exceptions are caught and logged, never propagated.
     */
    async handleUnknownInboundOpcode(event: UnknownOpcodeEvent): Promise<void> {
        try {
            if (this.unknownHandler) {
                await this.unknownHandler(event);
            } else {
                console.warn(
                    `[NetworkServerRuntime] Unknown opcode ${event.opcode} from session ${event.sessionId} (${event.payload.length} bytes)`
                );
            }
        } catch (err) {
            console.error(`[NetworkServerRuntime] unknown handler failed`, err);
        }
    }
}

/**
 * Create server runtime for Sample protocol group
 * @param codec Optional codec (default: protobuf codec from Stub/Proxy)
 */
export function createServerRuntime(codec?: ICodec): NetworkServerRuntime {
    return new NetworkServerRuntime(codec);
}

/** Re-export types for convenience */
export { C2Sample, Sample2C };