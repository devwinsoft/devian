// <auto-generated>
// DO NOT EDIT - Generated by Devian Build System
// </auto-generated>

using System;
using System.Collections.Generic;
using System.Linq;
using System.Text.Json.Serialization;

namespace Devian.Tools.Models
{

    /// <summary>
    /// Tag Registry - Protobuf field number 관리
    /// 
    /// 위치: {domain}/proto-gen/manifest/{TableName}.tags.json
    /// 
    /// 규칙:
    /// - tag는 단조 증가 발급
    /// - 발급된 tag는 절대 변경/재사용 금지
    /// - 삭제 필드는 reserved로 남긴다
    /// - rename은 tag 유지
    /// </summary>
    public class TagRegistry
    {
        [JsonPropertyName("version")]
        public int Version { get; set; } = 1;

        /// <summary>
        /// 필드명 → tag 매핑
        /// </summary>
        [JsonPropertyName("fields")]
        public Dictionary<string, int> Fields { get; set; } = new();

        /// <summary>
        /// 삭제된 필드의 tag (재사용 금지)
        /// </summary>
        [JsonPropertyName("reserved_tags")]
        public List<int> ReservedTags { get; set; } = new();

        /// <summary>
        /// 삭제된 필드의 이름 (재사용 금지)
        /// </summary>
        [JsonPropertyName("reserved_names")]
        public List<string> ReservedNames { get; set; } = new();

        /// <summary>
        /// 다음 발급할 tag 번호
        /// </summary>
        [JsonIgnore]
        public int NextTag => Fields.Count > 0 
            ? Fields.Values.Max() + 1 
            : 1;

        /// <summary>
        /// 새 필드에 tag 발급
        /// </summary>
        public int AllocateTag(string fieldName)
        {
            if (Fields.ContainsKey(fieldName))
                return Fields[fieldName];

            if (ReservedNames.Contains(fieldName))
                throw new InvalidOperationException($"Field name '{fieldName}' is reserved");

            var tag = NextTag;
            while (ReservedTags.Contains(tag))
                tag++;

            Fields[fieldName] = tag;
            return tag;
        }

        /// <summary>
        /// 필드명 변경 (tag 유지)
        /// </summary>
        public void RenameField(string oldName, string newName)
        {
            if (!Fields.TryGetValue(oldName, out var tag))
                throw new KeyNotFoundException($"Field '{oldName}' not found");

            if (ReservedNames.Contains(newName))
                throw new InvalidOperationException($"Field name '{newName}' is reserved");

            Fields.Remove(oldName);
            Fields[newName] = tag;
        }

        /// <summary>
        /// 필드 삭제 (reserved 처리)
        /// </summary>
        public void DeleteField(string fieldName)
        {
            if (!Fields.TryGetValue(fieldName, out var tag))
                return;

            Fields.Remove(fieldName);
            ReservedTags.Add(tag);
            ReservedNames.Add(fieldName);
        }
    }
}
