using System.IO;
using System.Text;
using Devian.Tools.Models;

namespace Devian.Tools.Generators
{
    public static class TypeScriptTableGenerator
    {
        public static string Generate(TableSchema schema)
        {
            var sb = new StringBuilder();
            var typeName = GetTypeName(schema.FileName);
            
            sb.AppendLine("// <auto-generated>");
            sb.AppendLine("// DO NOT EDIT - Generated by Devian.Tools");
            sb.AppendLine("// </auto-generated>");
            sb.AppendLine();
            sb.AppendLine(string.Format("export type {0} = {{", typeName));
            
            foreach (var col in schema.Columns)
            {
                var tsType = MapToTypeScriptType(col.Type);
                var opt = col.Optional ? "?" : "";
                var nullable = col.Optional ? " | null" : "";
                var propName = TypeMapper.ToCamelCase(col.Name);
                
                if (col.IsKey)
                    sb.AppendLine("  /** Key column */");
                
                sb.AppendLine(string.Format("  {0}{1}: {2}{3};", propName, opt, tsType, nullable));
            }
            
            sb.AppendLine("};");
            return sb.ToString();
        }
        
        private static string GetTypeName(string fileName) 
        { 
            return TypeMapper.ToPascalCase(Path.GetFileNameWithoutExtension(fileName)) + "Row"; 
        }
        
        private static string MapToTypeScriptType(string type)
        {
            if (type.StartsWith("class:") || type.StartsWith("enum:"))
            {
                var name = type.Substring(type.IndexOf(':') + 1);
                if (name.EndsWith("[]")) 
                    return name.Substring(0, name.Length - 2) + "[]";
                return name;
            }
            
            switch (type)
            {
                case "string": return "string";
                case "int":
                case "float": return "number";
                case "bool": return "boolean";
                case "json": return "any";
                case "string[]": return "string[]";
                case "int[]":
                case "float[]": return "number[]";
                case "bool[]": return "boolean[]";
                default: return "any";
            }
        }
    }
}
