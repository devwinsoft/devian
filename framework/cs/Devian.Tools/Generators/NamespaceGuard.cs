// <auto-generated>
// DO NOT EDIT - Generated by Devian Build System
// </auto-generated>

using System;
using System.Collections.Generic;
using System.Linq;

namespace Devian.Tools.Generators
{

    /// <summary>
    /// 네임스페이스 규칙 검증
    /// 
    /// Hard Rule 9: 도메인 단일 네임스페이스
    /// - 도메인당 하나의 네임스페이스만 사용
    /// - 하위 네임스페이스(Devian.Common.*)는 금지
    /// </summary>
    public static class NamespaceGuard
    {
        /// <summary>
        /// 네임스페이스 유효성 검증
        /// </summary>
        public static (bool Valid, string? Error) Validate(string ns)
        {
            if (string.IsNullOrWhiteSpace(ns))
                return (false, "Namespace cannot be empty");

            // Devian.{Domain} 형식만 허용
            var parts = ns.Split('.');
            if (parts.Length != 2)
                return (false, $"Invalid namespace '{ns}': must be 'Devian.{{Domain}}' format (no sub-namespaces)");

            if (parts[0] != "Devian")
                return (false, $"Invalid namespace '{ns}': must start with 'Devian.'");

            if (!IsValidDomainName(parts[1]))
                return (false, $"Invalid domain name '{parts[1]}' in namespace '{ns}'");

            return (true, null);
        }

        /// <summary>
        /// 도메인명 유효성 검증
        /// </summary>
        public static bool IsValidDomainName(string domain)
        {
            if (string.IsNullOrWhiteSpace(domain))
                return false;

            // PascalCase 또는 simple name만 허용
            if (!char.IsUpper(domain[0]))
                return false;

            // 특수문자 금지
            return domain.All(c => char.IsLetterOrDigit(c));
        }

        /// <summary>
        /// 도메인 → 네임스페이스 변환 검증
        /// </summary>
        public static (bool Valid, string Namespace, string? Error) ValidateAndConvert(string domain)
        {
            var ns = DomainNamespace.ToCSharpNamespace(domain);
            var (valid, error) = Validate(ns);
            return (valid, ns, error);
        }

        /// <summary>
        /// 생성된 코드에서 잘못된 네임스페이스 사용 감지
        /// </summary>
        public static List<string> DetectViolations(string code)
        {
            var violations = new List<string>();
            var lines = code.Split('\n');

            foreach (var line in lines)
            {
                var trimmed = line.Trim();

                // namespace 선언 검사
                if (trimmed.StartsWith("namespace "))
                {
                    var ns = trimmed["namespace ".Length..].TrimEnd(';', '{', ' ');
                    var (valid, error) = Validate(ns);
                    if (!valid)
                    {
                        violations.Add($"Invalid namespace declaration: {ns} - {error}");
                    }
                }

                // using 선언에서 Devian.*.* 패턴 검사
                if (trimmed.StartsWith("using Devian."))
                {
                    var ns = trimmed["using ".Length..].TrimEnd(';', ' ');
                    var parts = ns.Split('.');
                    if (parts.Length > 2 && parts[0] == "Devian")
                    {
                        violations.Add($"Sub-namespace import detected: {ns}");
                    }
                }
            }

            return violations;
        }
    }
}
