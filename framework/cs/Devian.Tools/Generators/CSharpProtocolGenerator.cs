using System.Text;
using Devian.Tools.Models;

namespace Devian.Tools.Generators
{
    public static class CSharpProtocolGenerator
    {
        /// <summary>
        /// 프로토콜 C# 코드 생성.
        /// 네임스페이스는 도메인에서 고정 결정 (하위 네임스페이스 금지).
        /// </summary>
        public static string Generate(ProtocolSpec spec, string domain)
        {
            var csNamespace = DomainNamespace.GetCSharpNamespace(domain);
            DomainNamespace.ValidateNoSubNamespace(csNamespace);
            
            var sb = new StringBuilder();
            var allocator = new OpcodeAllocator();
            
            sb.AppendLine("// <auto-generated>");
            sb.AppendLine("// DO NOT EDIT - Generated by Devian.Tools");
            sb.AppendLine(string.Format("// Domain: {0}", domain));
            sb.AppendLine("// </auto-generated>");
            sb.AppendLine();
            sb.AppendLine("using MessagePack;");
            sb.AppendLine();
            sb.AppendLine(string.Format("namespace {0}", csNamespace));
            sb.AppendLine("{");
            
            foreach (var msg in spec.Messages)
            {
                allocator.Allocate(msg);
                sb.AppendLine("    [MessagePackObject]");
                sb.AppendLine(string.Format("    public sealed class {0}", msg.Name));
                sb.AppendLine("    {");
                
                int keyIndex = 0;
                foreach (var field in msg.Fields)
                {
                    var csType = TypeMapper.ToCSharp(field.Type, field.Optional);
                    var propName = TypeMapper.ToPascalCase(field.Name);
                    var defaultValue = GetDefaultValue(field.Type, field.Optional);
                    
                    sb.AppendLine(string.Format("        [Key({0})]", keyIndex++));
                    sb.AppendLine(string.Format("        public {0} {1} {{ get; set; }}{2}", csType, propName, defaultValue));
                }
                
                sb.AppendLine("    }");
                sb.AppendLine();
            }
            
            var nsName = TypeMapper.ToPascalCase(spec.Namespace != null ? spec.Namespace : "Protocol");
            sb.AppendLine(string.Format("    public static class {0}Opcode", nsName));
            sb.AppendLine("    {");
            
            foreach (var msg in spec.Messages)
            {
                var opcode = allocator.Get(msg.Name);
                sb.AppendLine(string.Format("        public const ushort {0} = {1};", msg.Name, opcode));
            }
            
            sb.AppendLine("    }");
            sb.AppendLine("}");
            
            return sb.ToString();
        }
        
        private static string GetDefaultValue(string type, bool optional)
        {
            if (optional) return "";
            switch (type)
            {
                case "string": return " = \"\";";
                default: return "";
            }
        }
    }
}
