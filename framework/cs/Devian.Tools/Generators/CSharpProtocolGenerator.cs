// <auto-generated>
// DO NOT EDIT - Generated by Devian Build System
// </auto-generated>

using System.Text;
using Devian.Tools.Models;

namespace Devian.Tools.Generators
{

    /// <summary>
    /// C# Protocol 클래스 생성기
    /// </summary>
    public static class CSharpProtocolGenerator
    {
        /// <summary>
        /// Protocol 파일 생성
        /// </summary>
        public static string Generate(ProtocolSpec spec, string ns)
        {
            var sb = new StringBuilder();

            // Header
            sb.AppendLine("// <auto-generated>");
            sb.AppendLine("// DO NOT EDIT - Generated by Devian Build System");
            sb.AppendLine("// </auto-generated>");
            sb.AppendLine();
            sb.AppendLine("using System;");
            sb.AppendLine("using System.Collections.Generic;");
            sb.AppendLine("using Devian.Core;");
            sb.AppendLine();
            sb.AppendLine($"namespace {ns}");
            sb.AppendLine("{");

            // Packet classes
            foreach (var packet in spec.Packets)
            {
                sb.AppendLine($"    /// <summary>");
                sb.AppendLine($"    /// {packet.Direction} packet");
                sb.AppendLine($"    /// </summary>");
                sb.AppendLine($"    public sealed class {packet.Name}");
                sb.AppendLine("    {");

                // Opcode constant
                if (packet.Opcode.HasValue)
                {
                    sb.AppendLine($"        public const int Opcode = {packet.Opcode.Value};");
                    sb.AppendLine();
                }

                // Fields
                foreach (var field in packet.Fields)
                {
                    var csType = TypeMapper.ToCSharpType(field.Type);
                    var propName = toPascalCase(field.Name);

                    if (!string.IsNullOrEmpty(field.Comment))
                    {
                        sb.AppendLine($"        /// <summary>{field.Comment}</summary>");
                    }
                    if (field.Optional)
                    {
                        sb.AppendLine($"        public {csType}? {propName} {{ get; set; }}");
                    }
                    else
                    {
                        sb.AppendLine($"        public {csType} {propName} {{ get; set; }}");
                    }
                }

                sb.AppendLine("    }");
                sb.AppendLine();
            }

            sb.AppendLine("}");

            return sb.ToString().TrimEnd();
        }

        private static string toPascalCase(string input)
        {
            if (string.IsNullOrEmpty(input)) return input;
            return char.ToUpper(input[0]) + (input.Length > 1 ? input[1..] : "");
        }
    }
}
