// <auto-generated>
// DO NOT EDIT - Generated by Devian Build System
// </auto-generated>

using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Text;
using System.Text.Json;

namespace Devian.Tools.Generators
{

    /// <summary>
    /// Unity UPM 패키지 스캐폴드 생성기
    /// package.json, .asmdef 파일 생성
    /// </summary>
    public static class UnityUpmScaffoldGenerator
    {
        /// <summary>
        /// UPM package.json 생성
        /// </summary>
        public static string GeneratePackageJson(string packageId, string displayName, string version = "0.1.0")
        {
            var obj = new
            {
                name = packageId,
                version = version,
                displayName = displayName,
                description = $"Devian generated package: {displayName}",
                unity = "2021.3"
            };

            var options = new JsonSerializerOptions { WriteIndented = true };
            return JsonSerializer.Serialize(obj, options);
        }

        /// <summary>
        /// Runtime .asmdef 생성
        /// </summary>
        public static string GenerateRuntimeAsmdef(string ns, List<string>? references = null)
        {
            var obj = new
            {
                name = ns,
                rootNamespace = ns,
                references = references ?? new List<string>(),
                includePlatforms = Array.Empty<string>(),
                excludePlatforms = Array.Empty<string>(),
                allowUnsafeCode = false,
                overrideReferences = false,
                precompiledReferences = Array.Empty<string>(),
                autoReferenced = true,
                defineConstraints = Array.Empty<string>(),
                versionDefines = Array.Empty<object>(),
                noEngineReferences = true
            };

            var options = new JsonSerializerOptions { WriteIndented = true };
            return JsonSerializer.Serialize(obj, options);
        }

        /// <summary>
        /// Editor .asmdef 생성
        /// </summary>
        public static string GenerateEditorAsmdef(string ns, List<string>? references = null)
        {
            var refs = references?.ToList() ?? new List<string>();
            refs.Insert(0, ns); // Runtime 참조 추가

            var obj = new
            {
                name = $"{ns}.Editor",
                rootNamespace = $"{ns}.Editor",
                references = refs,
                includePlatforms = new[] { "Editor" },
                excludePlatforms = Array.Empty<string>(),
                allowUnsafeCode = false,
                overrideReferences = false,
                precompiledReferences = Array.Empty<string>(),
                autoReferenced = true,
                defineConstraints = Array.Empty<string>(),
                versionDefines = Array.Empty<object>(),
                noEngineReferences = true
            };

            var options = new JsonSerializerOptions { WriteIndented = true };
            return JsonSerializer.Serialize(obj, options);
        }

        /// <summary>
        /// 스캐폴드 파일 생성 (덮어쓰기 금지)
        /// </summary>
        public static void EnsureScaffold(string targetDir, string packageId, string ns)
        {
            var runtimeDir = Path.Combine(targetDir, "Runtime");
            var editorDir = Path.Combine(targetDir, "Editor");

            Directory.CreateDirectory(runtimeDir);
            Directory.CreateDirectory(editorDir);

            var displayName = ns.Split('.').Last();
            var packageJsonPath = Path.Combine(targetDir, "package.json");
            var runtimeAsmdefPath = Path.Combine(runtimeDir, $"{ns}.asmdef");
            var editorAsmdefPath = Path.Combine(editorDir, $"{ns}.Editor.asmdef");

            // 이미 존재하면 덮어쓰지 않음
            if (!File.Exists(packageJsonPath))
                File.WriteAllText(packageJsonPath, GeneratePackageJson(packageId, displayName));

            if (!File.Exists(runtimeAsmdefPath))
                File.WriteAllText(runtimeAsmdefPath, GenerateRuntimeAsmdef(ns));

            if (!File.Exists(editorAsmdefPath))
                File.WriteAllText(editorAsmdefPath, GenerateEditorAsmdef(ns));
        }
    }
}
