// <auto-generated>
// DO NOT EDIT - Generated by Devian Build System
// </auto-generated>

using Devian.Tools.Models;
using System.Collections.Generic;
using System.Linq;
using System.Text;

namespace Devian.Tools.Generators
{
    /// <summary>
    /// C# Bootstrap 클래스 생성기.
    /// 
    /// 생성 규칙:
    /// - 도메인별 Devian.{Domain}.Bootstrap 클래스 생성
    /// - 테이블별 ProtobufEntityConverter singleton 관리
    /// - internal _Encode/_Decode helper 제공
    /// - TB public API에서 converter 노출 없음
    /// </summary>
    public static class CSharpBootstrapGenerator
    {
        /// <summary>
        /// Bootstrap 클래스 생성
        /// </summary>
        /// <param name="tables">테이블 스펙 목록</param>
        /// <param name="ns">네임스페이스 (예: Devian.Common)</param>
        public static string Generate(IEnumerable<TableSpec> tables, string ns)
        {
            var tableList = tables.ToList();
            var sb = new StringBuilder();

            // Header
            sb.AppendLine("// <auto-generated>");
            sb.AppendLine("// DO NOT EDIT - Generated by Devian Build System");
            sb.AppendLine("// </auto-generated>");
            sb.AppendLine();
            sb.AppendLine("using System;");
            sb.AppendLine("using System.Collections.Generic;");
            sb.AppendLine("using System.IO;");
            sb.AppendLine("using Devian.Protobuf;");
            sb.AppendLine("using Google.Protobuf;");
            sb.AppendLine();
            sb.AppendLine($"namespace {ns}");
            sb.AppendLine("{");

            // Bootstrap class
            sb.AppendLine("    /// <summary>");
            sb.AppendLine("    /// 도메인 Bootstrap 클래스.");
            sb.AppendLine("    /// Protobuf converter 초기화 및 binary encode/decode helper 제공.");
            sb.AppendLine("    /// </summary>");
            sb.AppendLine("    public static class Bootstrap");
            sb.AppendLine("    {");

            // Initialized flag
            sb.AppendLine("        private static bool _initialized;");
            sb.AppendLine();

            // Converter fields
            foreach (var table in tableList)
            {
                sb.AppendLine($"        private static ProtobufEntityConverter<{table.RowTypeName}, Proto.{table.RowTypeName}>? _converter_{table.TableName};");
            }
            sb.AppendLine();

            // Init method
            sb.AppendLine("        /// <summary>");
            sb.AppendLine("        /// Converter 초기화. 중복 호출 안전(idempotent).");
            sb.AppendLine("        /// </summary>");
            sb.AppendLine("        public static void Init()");
            sb.AppendLine("        {");
            sb.AppendLine("            if (_initialized) return;");
            sb.AppendLine();
            foreach (var table in tableList)
            {
                sb.AppendLine($"            _converter_{table.TableName} = new ProtobufEntityConverter<{table.RowTypeName}, Proto.{table.RowTypeName}>(Proto.{table.RowTypeName}.Parser);");
            }
            sb.AppendLine();
            sb.AppendLine("            _initialized = true;");
            sb.AppendLine("        }");
            sb.AppendLine();

            // Internal helpers for each table
            foreach (var table in tableList)
            {
                var rowType = table.RowTypeName;
                var protoType = $"Proto.{table.RowTypeName}";

                // _Decode_{TableName}
                sb.AppendLine($"        /// <summary>");
                sb.AppendLine($"        /// {table.TableName} binary decode helper.");
                sb.AppendLine($"        /// </summary>");
                sb.AppendLine($"        internal static IReadOnlyList<{rowType}> _Decode_{table.TableName}(byte[] bytes)");
                sb.AppendLine("        {");
                sb.AppendLine("            if (!_initialized) Init();");
                sb.AppendLine();
                sb.AppendLine($"            var rows = new List<{rowType}>();");
                sb.AppendLine("            using var ms = new MemoryStream(bytes);");
                sb.AppendLine("            while (ms.Position < ms.Length)");
                sb.AppendLine("            {");
                sb.AppendLine($"                var proto = {protoType}.Parser.ParseDelimitedFrom(ms);");
                sb.AppendLine($"                var row = new {rowType}();");
                sb.AppendLine("                row._LoadProto(proto);");
                sb.AppendLine("                rows.Add(row);");
                sb.AppendLine("            }");
                sb.AppendLine("            return rows;");
                sb.AppendLine("        }");
                sb.AppendLine();

                // _Encode_{TableName}
                sb.AppendLine($"        /// <summary>");
                sb.AppendLine($"        /// {table.TableName} binary encode helper.");
                sb.AppendLine($"        /// </summary>");
                sb.AppendLine($"        internal static byte[] _Encode_{table.TableName}(IReadOnlyList<{rowType}> rows)");
                sb.AppendLine("        {");
                sb.AppendLine("            if (!_initialized) Init();");
                sb.AppendLine();
                sb.AppendLine("            using var ms = new MemoryStream();");
                sb.AppendLine("            foreach (var row in rows)");
                sb.AppendLine("            {");
                sb.AppendLine("                var proto = row._SaveProto();");
                sb.AppendLine("                proto.WriteDelimitedTo(ms);");
                sb.AppendLine("            }");
                sb.AppendLine("            return ms.ToArray();");
                sb.AppendLine("        }");
                sb.AppendLine();
            }

            sb.AppendLine("    }");
            sb.AppendLine("}");

            return sb.ToString();
        }
    }
}
