using System;
using System.Collections.Generic;
using System.Text;
using System.Text.Json;
using System.Text.Json.Serialization;

namespace Devian.Tools.Generators
{
    /// <summary>
    /// Contract Spec(JSON)에서 C# 타입(enum, class)을 생성한다.
    /// 네임스페이스는 도메인에서 고정 결정 (하위 네임스페이스 금지).
    /// </summary>
    public static class CSharpContractGenerator
    {
        /// <summary>
        /// enum 하나를 C# 코드로 생성
        /// </summary>
        public static string GenerateEnum(EnumSpec spec, string domain)
        {
            var csNamespace = DomainNamespace.GetCSharpNamespace(domain);
            DomainNamespace.ValidateNoSubNamespace(csNamespace);
            
            var sb = new StringBuilder();
            sb.AppendLine("// <auto-generated>");
            sb.AppendLine("// DO NOT EDIT - Generated by Devian.Tools");
            sb.AppendLine(string.Format("// Domain: {0}", domain));
            sb.AppendLine("// </auto-generated>");
            sb.AppendLine();
            sb.AppendLine(string.Format("namespace {0}", csNamespace));
            sb.AppendLine("{");
            sb.AppendLine(string.Format("    public enum {0}", spec.Name));
            sb.AppendLine("    {");
            
            for (int i = 0; i < spec.Values.Count; i++)
            {
                var val = spec.Values[i];
                var comma = (i < spec.Values.Count - 1) ? "," : "";
                sb.AppendLine(string.Format("        {0} = {1}{2}", val.Name, val.Value, comma));
            }
            
            sb.AppendLine("    }");
            sb.AppendLine("}");
            
            return sb.ToString();
        }
        
        /// <summary>
        /// class 하나를 C# 코드로 생성
        /// </summary>
        public static string GenerateClass(ClassSpec spec, string domain)
        {
            var csNamespace = DomainNamespace.GetCSharpNamespace(domain);
            DomainNamespace.ValidateNoSubNamespace(csNamespace);
            
            var sb = new StringBuilder();
            sb.AppendLine("// <auto-generated>");
            sb.AppendLine("// DO NOT EDIT - Generated by Devian.Tools");
            sb.AppendLine(string.Format("// Domain: {0}", domain));
            sb.AppendLine("// </auto-generated>");
            sb.AppendLine();
            sb.AppendLine(string.Format("namespace {0}", csNamespace));
            sb.AppendLine("{");
            sb.AppendLine(string.Format("    public sealed class {0}", spec.Name));
            sb.AppendLine("    {");
            
            var hasStringField = false;
            foreach (var field in spec.Fields)
            {
                var csType = TypeMapper.ToCSharp(field.Type, field.Optional);
                var propName = TypeMapper.ToPascalCase(field.Name);
                sb.AppendLine(string.Format("        public {0} {1} {{ get; set; }}", csType, propName));
                if (csType == "string") hasStringField = true;
            }
            
            // 기본 생성자 (string 필드 초기화)
            if (hasStringField)
            {
                sb.AppendLine();
                sb.AppendLine(string.Format("        public {0}()", spec.Name));
                sb.AppendLine("        {");
                foreach (var field in spec.Fields)
                {
                    var csType = TypeMapper.ToCSharp(field.Type, field.Optional);
                    var propName = TypeMapper.ToPascalCase(field.Name);
                    if (csType == "string")
                        sb.AppendLine(string.Format("            {0} = \"\";", propName));
                }
                sb.AppendLine("        }");
            }
            
            sb.AppendLine("    }");
            sb.AppendLine("}");
            
            return sb.ToString();
        }
    }
    
    #region Contract Spec Models
    
    public class ContractSpec
    {
        [JsonPropertyName("enums")]
        public List<EnumSpec> Enums { get; set; } = new List<EnumSpec>();
        
        [JsonPropertyName("classes")]
        public List<ClassSpec> Classes { get; set; } = new List<ClassSpec>();
    }
    
    public class EnumSpec
    {
        [JsonPropertyName("name")]
        public string Name { get; set; }
        
        [JsonPropertyName("values")]
        public List<EnumValueSpec> Values { get; set; } = new List<EnumValueSpec>();
    }
    
    public class EnumValueSpec
    {
        [JsonPropertyName("name")]
        public string Name { get; set; }
        
        [JsonPropertyName("value")]
        public int Value { get; set; }
    }
    
    public class ClassSpec
    {
        [JsonPropertyName("name")]
        public string Name { get; set; }
        
        [JsonPropertyName("fields")]
        public List<FieldSpec> Fields { get; set; } = new List<FieldSpec>();
    }
    
    public class FieldSpec
    {
        [JsonPropertyName("name")]
        public string Name { get; set; }
        
        [JsonPropertyName("type")]
        public string Type { get; set; }
        
        [JsonPropertyName("optional")]
        public bool Optional { get; set; }
    }
    
    #endregion
}
