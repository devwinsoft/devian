// <auto-generated>
// DO NOT EDIT - Generated by Devian Build System
// </auto-generated>

using Devian.Tools.Models;
using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Text;
using System.Text.Json;

namespace Devian.Tools.Generators
{

    /// <summary>
    /// Excel → Proto 생성기
    /// 
    /// 규칙:
    /// - Table 1개 = proto 파일 1개
    /// - proto 파일은 message 1개만 포함
    /// - field number는 Tag Registry 기반
    /// - ref 대상은 자동 import 생성
    /// </summary>
    public static class ProtoGenerator
    {
        /// <summary>
        /// Proto 파일 생성
        /// </summary>
        public static string Generate(TableSpec spec, TagRegistry registry, string packageName)
        {
            var sb = new StringBuilder();

            // Header
            sb.AppendLine("// <auto-generated>");
            sb.AppendLine("// DO NOT EDIT - Generated by Devian Build System");
            sb.AppendLine("// </auto-generated>");
            sb.AppendLine();
            sb.AppendLine("syntax = \"proto3\";");
            sb.AppendLine();
            sb.AppendLine($"package {packageName};");
            sb.AppendLine();

            // Imports
            var imports = collectImports(spec);
            foreach (var import in imports.OrderBy(i => i))
            {
                sb.AppendLine($"import \"{import}\";");
            }
            if (imports.Count > 0)
                sb.AppendLine();

            // Message
            sb.AppendLine($"message {spec.RowTypeName} {{");

            // Reserved (삭제된 필드)
            if (registry.ReservedTags.Count > 0)
            {
                sb.AppendLine($"  reserved {string.Join(", ", registry.ReservedTags)};");
            }
            if (registry.ReservedNames.Count > 0)
            {
                var names = registry.ReservedNames.Select(n => $"\"{n}\"");
                sb.AppendLine($"  reserved {string.Join(", ", names)};");
            }
            if (registry.ReservedTags.Count > 0 || registry.ReservedNames.Count > 0)
                sb.AppendLine();

            // Fields
            foreach (var col in spec.Columns)
            {
                var protoType = TypeMapper.ToProtoType(col.Type);
                var tag = registry.AllocateTag(col.Name);
                var fieldName = toSnakeCase(col.Name);

                if (!string.IsNullOrEmpty(col.Comment))
                {
                    sb.AppendLine($"  // {col.Comment}");
                }
                sb.AppendLine($"  {protoType} {fieldName} = {tag};");
            }

            sb.AppendLine("}");

            return sb.ToString();
        }

        /// <summary>
        /// import 대상 수집
        /// </summary>
        private static HashSet<string> collectImports(TableSpec spec)
        {
            var imports = new HashSet<string>();

            foreach (var col in spec.Columns)
            {
                var (kind, isCommon, typeName) = TypeMapper.ParseRefType(col.Type);
                if (kind == TypeMapper.RefKind.None || typeName == null) continue;

                // Common 도메인 ref
                if (isCommon)
                {
                    // Common contracts에서 타입 참조
                    imports.Add($"Common/proto-gen/schema/{toSnakeCase(typeName)}.proto");
                }
                else
                {
                    // 로컬 도메인 ref
                    imports.Add($"proto-gen/schema/{toSnakeCase(typeName)}.proto");
                }
            }

            return imports;
        }

        /// <summary>
        /// PascalCase → snake_case 변환
        /// </summary>
        private static string toSnakeCase(string input)
        {
            if (string.IsNullOrEmpty(input)) return input;

            var sb = new StringBuilder();
            for (int i = 0; i < input.Length; i++)
            {
                var c = input[i];
                if (char.IsUpper(c))
                {
                    if (i > 0) sb.Append('_');
                    sb.Append(char.ToLower(c));
                }
                else
                {
                    sb.Append(c);
                }
            }
            return sb.ToString();
        }

        /// <summary>
        /// Tag Registry 로드 또는 생성
        /// </summary>
        public static TagRegistry LoadOrCreateRegistry(string registryPath)
        {
            if (File.Exists(registryPath))
            {
                var json = File.ReadAllText(registryPath);
                return JsonSerializer.Deserialize<TagRegistry>(json) ?? new TagRegistry();
            }
            return new TagRegistry();
        }

        /// <summary>
        /// Tag Registry 저장
        /// </summary>
        public static void SaveRegistry(TagRegistry registry, string registryPath)
        {
            var dir = Path.GetDirectoryName(registryPath);
            if (!string.IsNullOrEmpty(dir) && !Directory.Exists(dir))
                Directory.CreateDirectory(dir);

            var options = new JsonSerializerOptions { WriteIndented = true };
            var json = JsonSerializer.Serialize(registry, options);
            File.WriteAllText(registryPath, json);
        }
    }
}
