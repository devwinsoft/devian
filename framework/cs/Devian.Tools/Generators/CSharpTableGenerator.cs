// <auto-generated>
// Devian Build System - C# Table Generator
// </auto-generated>

using System.Linq;
using System.Text;
using Devian.Tools.Models;

namespace Devian.Tools.Generators
{
    /// <summary>
    /// Table Spec → C# 코드 생성 (61-tablegen-implementation)
    /// - Row Entity: IEntity / IEntityWithKey
    /// - Table Container: TB_{TableName}
    /// </summary>
    public static class CSharpTableGenerator
    {
        /// <summary>
        /// Row Entity 클래스 생성
        /// </summary>
        public static string GenerateEntity(TableSpec table)
        {
            var sb = new StringBuilder();
            var ns = $"Devian.{table.Domain}";
            var className = table.TableName;
            var hasKey = table.PrimaryKeyIndex >= 0;

            // Header
            sb.AppendLine("// <auto-generated>");
            sb.AppendLine("// DO NOT EDIT - Generated by Devian Build System");
            sb.AppendLine("// </auto-generated>");
            sb.AppendLine();
            sb.AppendLine("using Devian.Core;");
            sb.AppendLine();
            sb.AppendLine($"namespace {ns}");
            sb.AppendLine("{");

            // Class declaration
            var keyCol = hasKey ? table.Columns[table.PrimaryKeyIndex] : null;
            var keyType = keyCol != null ? TableTypeMapper.ToCSharp(keyCol.Type) : "int";

            if (hasKey)
            {
                sb.AppendLine($"    public sealed class {className} : IEntity");
            }
            else
            {
                sb.AppendLine($"    public sealed class {className} : IEntity");
            }
            sb.AppendLine("    {");

            // Properties
            foreach (var col in table.Columns)
            {
                var csType = TableTypeMapper.ToCSharp(col.Type);
                var propName = ToPascalCase(col.Name);
                var defaultValue = GetDefaultValue(csType, col.IsOptional);

                if (col.IsOptional && !col.IsKey)
                {
                    sb.AppendLine($"        public {csType}? {propName} {{ get; set; }}");
                }
                else if (!string.IsNullOrEmpty(defaultValue))
                {
                    sb.AppendLine($"        public {csType} {propName} {{ get; set; }} = {defaultValue};");
                }
                else
                {
                    sb.AppendLine($"        public {csType} {propName} {{ get; set; }}");
                }
            }

            // GetKey() implementation
            sb.AppendLine();
            if (hasKey && keyCol != null)
            {
                sb.AppendLine($"        public object GetKey() => {ToPascalCase(keyCol.Name)};");
            }
            else
            {
                sb.AppendLine("        public object GetKey() => null!;");
            }

            sb.AppendLine("    }");
            sb.AppendLine("}");

            return sb.ToString().TrimEnd();
        }

        /// <summary>
        /// Table Container (TB_{TableName}) 생성
        /// </summary>
        public static string GenerateContainer(TableSpec table)
        {
            if (table.PrimaryKeyIndex < 0) return ""; // Key 없으면 컨테이너 미생성

            var sb = new StringBuilder();
            var className = $"TB_{table.TableName}";
            var rowType = table.TableName;
            var keyCol = table.Columns[table.PrimaryKeyIndex];
            var keyType = TableTypeMapper.ToCSharp(keyCol.Type);
            var keyProp = ToPascalCase(keyCol.Name);

            // Header
            sb.AppendLine("// <auto-generated>");
            sb.AppendLine("// DO NOT EDIT - Generated by Devian Build System");
            sb.AppendLine("// </auto-generated>");
            sb.AppendLine();
            sb.AppendLine("using System;");
            sb.AppendLine("using System.Collections.Generic;");
            sb.AppendLine("using System.Text.Json;");
            sb.AppendLine("using Devian.Core;");
            sb.AppendLine($"using Devian.{table.Domain};");
            sb.AppendLine();
            sb.AppendLine("namespace Devian.Table");
            sb.AppendLine("{");
            sb.AppendLine($"    /// <summary>");
            sb.AppendLine($"    /// Table container for {table.TableName}");
            sb.AppendLine($"    /// </summary>");
            sb.AppendLine($"    public static class {className}");
            sb.AppendLine("    {");

            // Cache dictionary
            sb.AppendLine($"        private static readonly Dictionary<{keyType}, {rowType}> _cache = new();");
            sb.AppendLine();

            // Get by key
            sb.AppendLine($"        public static {rowType}? Get({keyType} key)");
            sb.AppendLine("        {");
            sb.AppendLine("            return _cache.TryGetValue(key, out var row) ? row : null;");
            sb.AppendLine("        }");
            sb.AppendLine();

            // GetAll
            sb.AppendLine($"        public static IEnumerable<{rowType}> GetAll() => _cache.Values;");
            sb.AppendLine();

            // Count
            sb.AppendLine("        public static int Count => _cache.Count;");
            sb.AppendLine();

            // Clear
            sb.AppendLine("        public static void Clear() => _cache.Clear();");
            sb.AppendLine();

            // LoadFromJson (NDJSON)
            sb.AppendLine($"        public static void LoadFromJson(string ndjson, LoadMode mode = LoadMode.Merge)");
            sb.AppendLine("        {");
            sb.AppendLine("            if (mode == LoadMode.Replace) _cache.Clear();");
            sb.AppendLine();
            sb.AppendLine("            var lines = ndjson.Split('\\n', StringSplitOptions.RemoveEmptyEntries);");
            sb.AppendLine("            foreach (var line in lines)");
            sb.AppendLine("            {");
            sb.AppendLine($"                var row = JsonSerializer.Deserialize<{rowType}>(line);");
            sb.AppendLine("                if (row != null)");
            sb.AppendLine("                {");
            sb.AppendLine($"                    _cache[row.{keyProp}] = row;");
            sb.AppendLine("                }");
            sb.AppendLine("            }");
            sb.AppendLine("        }");
            sb.AppendLine();

            // SaveToJson (NDJSON)
            sb.AppendLine("        public static string SaveToJson()");
            sb.AppendLine("        {");
            sb.AppendLine("            var lines = new List<string>();");
            sb.AppendLine("            foreach (var row in _cache.Values)");
            sb.AppendLine("            {");
            sb.AppendLine("                lines.Add(JsonSerializer.Serialize(row));");
            sb.AppendLine("            }");
            sb.AppendLine("            return string.Join(\"\\n\", lines);");
            sb.AppendLine("        }");

            sb.AppendLine("    }");
            sb.AppendLine("}");

            return sb.ToString().TrimEnd();
        }

        private static string ToPascalCase(string input)
        {
            if (string.IsNullOrEmpty(input)) return input;
            return char.ToUpper(input[0]) + (input.Length > 1 ? input[1..] : "");
        }

        private static string GetDefaultValue(string csType, bool optional)
        {
            if (optional) return "";
            if (csType == "string") return "\"\"";
            if (csType.EndsWith("[]"))
            {
                var elementType = csType[..^2];
                return $"Array.Empty<{elementType}>()";
            }
            return "";
        }
    }
}
