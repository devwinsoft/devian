using System;
using System.IO;
using System.Text;
using Devian.Tools.Models;

namespace Devian.Tools.Generators
{
    public static class CSharpTableGenerator
    {
        /// <summary>
        /// 테이블 Row C# 코드 생성.
        /// 네임스페이스는 도메인에서 고정 결정 (하위 네임스페이스 금지).
        /// </summary>
        public static string Generate(TableSchema schema, string domain)
        {
            var csNamespace = DomainNamespace.GetCSharpNamespace(domain);
            DomainNamespace.ValidateNoSubNamespace(csNamespace);
            
            var sb = new StringBuilder();
            var className = GetClassName(schema.FileName);
            
            sb.AppendLine("// <auto-generated>");
            sb.AppendLine("// DO NOT EDIT - Generated by Devian.Tools");
            sb.AppendLine(string.Format("// Domain: {0}", domain));
            sb.AppendLine("// </auto-generated>");
            sb.AppendLine();
            sb.AppendLine("using System;");
            sb.AppendLine();
            sb.AppendLine(string.Format("namespace {0}", csNamespace));
            sb.AppendLine("{");
            sb.AppendLine(string.Format("    public sealed class {0}", className));
            sb.AppendLine("    {");
            
            foreach (var col in schema.Columns)
            {
                var csType = MapToCSharpType(col.Type, col.Optional);
                var propName = TypeMapper.ToPascalCase(col.Name);
                var defaultValue = GetDefaultValue(col.Type, col.Optional);
                
                if (col.IsKey)
                    sb.AppendLine("        /// <summary>Key column</summary>");
                
                sb.AppendLine(string.Format("        public {0} {1} {{ get; set; }}{2}", csType, propName, defaultValue));
            }
            
            sb.AppendLine("    }");
            sb.AppendLine("}");
            
            return sb.ToString();
        }
        
        private static string GetClassName(string fileName) 
        { 
            return TypeMapper.ToPascalCase(Path.GetFileNameWithoutExtension(fileName)) + "Row"; 
        }
        
        private static string MapToCSharpType(string type, bool optional)
        {
            if (type.StartsWith("class:") || type.StartsWith("enum:"))
            {
                var name = type.Substring(type.IndexOf(':') + 1);
                if (name.EndsWith("[]")) 
                    name = name.Substring(0, name.Length - 2) + "[]";
                return name;
            }
            
            switch (type)
            {
                case "string": return "string";
                case "int": return "int";
                case "float": return "float";
                case "bool": return "bool";
                case "json": return "object";
                case "string[]": return "string[]";
                case "int[]": return "int[]";
                case "float[]": return "float[]";
                case "bool[]": return "bool[]";
                default: return "object";
            }
        }
        
        private static string GetDefaultValue(string type, bool optional)
        {
            if (type.StartsWith("class:") || type.StartsWith("enum:")) 
                return "";
            
            switch (type)
            {
                case "string": return " = \"\";";
                case "string[]": return " = Array.Empty<string>();";
                case "int[]": return " = Array.Empty<int>();";
                case "float[]": return " = Array.Empty<float>();";
                case "bool[]": return " = Array.Empty<bool>();";
                default: return "";
            }
        }
    }
}
