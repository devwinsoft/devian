// <auto-generated>
// DO NOT EDIT - Generated by Devian Build System
// </auto-generated>

using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Text;
using System.Text.Json;

namespace Devian.Tools.Generators
{

    /// <summary>
    /// Node.js/TypeScript 라이브러리 스캐폴드 생성기
    /// package.json, tsconfig.json, index.ts 생성
    /// </summary>
    public static class NodeJsLibraryScaffoldGenerator
    {
        /// <summary>
        /// package.json 생성
        /// </summary>
        public static string GeneratePackageJson(string packageName, string version = "0.1.0")
        {
            var obj = new
            {
                name = packageName,
                version = version,
                main = "dist/index.js",
                types = "dist/index.d.ts",
                scripts = new
                {
                    build = "tsc",
                    clean = "rimraf dist"
                },
                devDependencies = new
                {
                    typescript = "^5.0.0"
                }
            };

            var options = new JsonSerializerOptions { WriteIndented = true };
            return JsonSerializer.Serialize(obj, options);
        }

        /// <summary>
        /// tsconfig.json 생성
        /// </summary>
        public static string GenerateTsConfig()
        {
            return @"{
  ""compilerOptions"": {
    ""target"": ""ES2020"",
    ""module"": ""CommonJS"",
    ""lib"": [""ES2020""],
    ""declaration"": true,
    ""strict"": true,
    ""noImplicitAny"": true,
    ""strictNullChecks"": true,
    ""noImplicitThis"": true,
    ""alwaysStrict"": true,
    ""noUnusedLocals"": false,
    ""noUnusedParameters"": false,
    ""noImplicitReturns"": true,
    ""noFallthroughCasesInSwitch"": false,
    ""inlineSourceMap"": true,
    ""inlineSources"": true,
    ""esModuleInterop"": true,
    ""outDir"": ""./dist"",
    ""rootDir"": ""./"" 
  },
  ""include"": [""./**/*.ts""],
  ""exclude"": [""node_modules"", ""dist""]
}";
        }

        /// <summary>
        /// index.ts (barrel export) 생성
        /// </summary>
        public static string GenerateIndexTs(List<string> exports)
        {
            var sb = new StringBuilder();

            sb.AppendLine("// <auto-generated>");
            sb.AppendLine("// DO NOT EDIT - Generated by Devian Build System");
            sb.AppendLine("// </auto-generated>");
            sb.AppendLine();

            foreach (var exp in exports.OrderBy(e => e))
            {
                sb.AppendLine($"export * from './{exp}';");
            }

            return sb.ToString();
        }

        /// <summary>
        /// 스캐폴드 파일 생성 (덮어쓰기 금지)
        /// </summary>
        public static void EnsureScaffold(string targetDir, string packageName)
        {
            if (!Directory.Exists(targetDir))
                Directory.CreateDirectory(targetDir);

            var packageJsonPath = Path.Combine(targetDir, "package.json");
            var tsconfigPath = Path.Combine(targetDir, "tsconfig.json");
            var indexPath = Path.Combine(targetDir, "index.ts");

            // 이미 존재하면 덮어쓰지 않음
            if (!File.Exists(packageJsonPath))
                File.WriteAllText(packageJsonPath, GeneratePackageJson(packageName));

            if (!File.Exists(tsconfigPath))
                File.WriteAllText(tsconfigPath, GenerateTsConfig());

            if (!File.Exists(indexPath))
                File.WriteAllText(indexPath, "// Barrel exports\nexport * from './generated';\n");
        }
    }
}
