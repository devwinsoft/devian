// <auto-generated>
// Unity Pool - PoolManager
// SSOT: skills/devian-upm/30-unity-components/02-pool-manager/SKILL.md
// </auto-generated>

using System;
using System.Collections.Generic;
using UnityEngine;

namespace Devian
{
    /// <summary>
    /// Central manager for object pools.
    /// Type identity: One pool per Type.
    /// </summary>
    public static class PoolManager
    {
        private static readonly Dictionary<Type, IPool> _pools = new Dictionary<Type, IPool>();
        private static IPoolFactory _factory;
        
        /// <summary>
        /// Initializes the PoolManager with a factory.
        /// Must be called before any Spawn/Despawn operations.
        /// </summary>
        public static void Initialize(IPoolFactory factory)
        {
            UnityMainThread.EnsureOrThrow("PoolManager.Initialize");
            _factory = factory ?? throw new ArgumentNullException(nameof(factory));
        }
        
        /// <summary>
        /// Gets or creates a pool for the specified type.
        /// </summary>
        public static Pool<T> GetOrCreatePool<T>(PoolOptions options = default) where T : Component, IPoolable<T>
        {
            UnityMainThread.EnsureOrThrow("PoolManager.GetOrCreatePool");
            
            var type = typeof(T);
            if (_pools.TryGetValue(type, out var existingPool))
            {
                return (Pool<T>)existingPool;
            }
            
            EnsureInitialized();
            
            if (options.MaxSize <= 0)
            {
                options = PoolOptions.Default;
            }
            
            var pool = new Pool<T>(_factory, options);
            _pools[type] = pool;
            return pool;
        }
        
        /// <summary>
        /// Gets or creates a pool for the specified type (non-generic version).
        /// </summary>
        public static IPool GetOrCreatePool(Type type, PoolOptions options = default)
        {
            UnityMainThread.EnsureOrThrow("PoolManager.GetOrCreatePool");
            
            if (type == null)
            {
                throw new ArgumentNullException(nameof(type));
            }
            
            if (_pools.TryGetValue(type, out var existingPool))
            {
                return existingPool;
            }
            
            EnsureInitialized();
            
            if (options.MaxSize <= 0)
            {
                options = PoolOptions.Default;
            }
            
            // Create Pool<T> using reflection
            var poolType = typeof(Pool<>).MakeGenericType(type);
            var pool = (IPool)Activator.CreateInstance(poolType, _factory, options);
            _pools[type] = pool;
            return pool;
        }
        
        /// <summary>
        /// Spawns an instance of the specified type by prefab name.
        /// </summary>
        public static T Spawn<T>(string name, Vector3 position = default, Quaternion rotation = default, Transform parent = null) 
            where T : Component, IPoolable<T>
        {
            var pool = GetOrCreatePool<T>();
            return pool.Spawn(name, position, rotation, parent);
        }
        
        /// <summary>
        /// Spawns an instance by prefab name. Type is determined by the factory.
        /// </summary>
        public static Component Spawn(string name, Vector3 position = default, Quaternion rotation = default, Transform parent = null)
        {
            UnityMainThread.EnsureOrThrow("PoolManager.Spawn");
            EnsureInitialized();
            
            var prefab = _factory.GetPrefab(name);
            if (prefab == null)
            {
                throw new InvalidOperationException($"Prefab '{name}' not found by factory.");
            }
            
            var type = _factory.GetPoolType(prefab);
            var pool = GetOrCreatePool(type);
            return pool.Spawn(name, position, rotation, parent);
        }
        
        /// <summary>
        /// Despawns an instance back to its pool.
        /// </summary>
        public static void Despawn(Component instance)
        {
            UnityMainThread.EnsureOrThrow("PoolManager.Despawn");
            
            if (instance == null)
            {
                throw new ArgumentNullException(nameof(instance));
            }
            
            var type = instance.GetType();
            if (!_pools.TryGetValue(type, out var pool))
            {
                throw new InvalidOperationException(
                    $"No pool found for type {type.Name}. Was this instance spawned from PoolManager?");
            }
            
            pool.Despawn(instance);
        }
        
        /// <summary>
        /// Clears the pool for the specified type.
        /// </summary>
        public static void Clear<T>() where T : Component, IPoolable<T>
        {
            Clear(typeof(T));
        }
        
        /// <summary>
        /// Clears the pool for the specified type.
        /// </summary>
        public static void Clear(Type type)
        {
            UnityMainThread.EnsureOrThrow("PoolManager.Clear");
            
            if (type != null && _pools.TryGetValue(type, out var pool))
            {
                pool.Clear();
            }
        }
        
        /// <summary>
        /// Clears all pools.
        /// </summary>
        public static void ClearAll()
        {
            UnityMainThread.EnsureOrThrow("PoolManager.ClearAll");
            
            foreach (var pool in _pools.Values)
            {
                pool.Clear();
            }
        }
        
        private static void EnsureInitialized()
        {
            if (_factory == null)
            {
                throw new InvalidOperationException(
                    "PoolManager not initialized. Call PoolManager.Initialize(factory) first.");
            }
        }
    }
}
