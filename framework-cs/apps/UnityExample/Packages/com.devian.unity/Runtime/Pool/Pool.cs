// <auto-generated>
// Unity Pool - Pool<T>
// SSOT: skills/devian-common-upm/30-unity-components/02-pool-manager/SKILL.md
// </auto-generated>

using System;
using System.Collections.Generic;
using UnityEngine;

namespace Devian
{
    /// <summary>
    /// Generic object pool for a specific component type.
    /// Type identity: One pool per Type.
    /// Spawn key: prefab name (string).
    /// </summary>
    /// <typeparam name="T">The poolable component type</typeparam>
    public sealed class Pool<T> : IPool where T : Component, IPoolable<T>
    {
        private readonly Dictionary<string, Queue<T>> _inactiveByName = new Dictionary<string, Queue<T>>();
        private readonly Dictionary<string, GameObject> _prefabByName = new Dictionary<string, GameObject>();
        private readonly HashSet<T> _activeInstances = new HashSet<T>();
        private readonly IPoolFactory _factory;
        private readonly int _maxSize;
        private readonly Transform _inactiveRoot;
        
        public Type ComponentType => typeof(T);
        
        public Pool(IPoolFactory factory, PoolOptions options)
        {
            _factory = factory ?? throw new ArgumentNullException(nameof(factory));
            _maxSize = options.MaxSize > 0 ? options.MaxSize : 512;
            _inactiveRoot = options.InactiveRoot;
        }
        
        /// <summary>
        /// Spawns a pooled instance by prefab name.
        /// </summary>
        public T Spawn(string name, Vector3 position = default, Quaternion rotation = default, Transform parent = null)
        {
            UnityMainThread.EnsureOrThrow("Pool.Spawn");
            
            if (string.IsNullOrEmpty(name))
            {
                throw new ArgumentException("Prefab name cannot be null or empty.", nameof(name));
            }
            
            // Get or cache prefab
            if (!_prefabByName.TryGetValue(name, out var prefab))
            {
                prefab = _factory.GetPrefab(name);
                if (prefab == null)
                {
                    throw new InvalidOperationException($"Prefab '{name}' not found by factory.");
                }
                
                // Verify pool type matches
                var poolType = _factory.GetPoolType(prefab);
                if (poolType != typeof(T))
                {
                    throw new InvalidOperationException(
                        $"Prefab '{name}' pool type is {poolType.Name}, expected {typeof(T).Name}.");
                }
                
                _prefabByName[name] = prefab;
            }
            
            T instance;
            
            // Try to get from inactive pool
            if (_inactiveByName.TryGetValue(name, out var queue) && queue.Count > 0)
            {
                instance = queue.Dequeue();
            }
            else
            {
                // Create new instance
                var component = _factory.CreateInstance(prefab);
                instance = component as T;
                if (instance == null)
                {
                    throw new InvalidOperationException(
                        $"Factory created instance of type {component.GetType().Name}, expected {typeof(T).Name}.");
                }
            }
            
            // Activate and position
            var go = instance.gameObject;
            go.SetActive(true);
            
            var transform = instance.transform;
            transform.SetParent(parent, false);
            transform.position = position;
            transform.rotation = rotation;
            
            // Track as active
            _activeInstances.Add(instance);
            
            // Notify
            instance.OnPoolSpawned();
            
            return instance;
        }
        
        Component IPool.Spawn(string name, Vector3 position, Quaternion rotation, Transform parent)
        {
            return Spawn(name, position, rotation, parent);
        }
        
        /// <summary>
        /// Returns an instance to the pool.
        /// </summary>
        public void Despawn(T instance)
        {
            UnityMainThread.EnsureOrThrow("Pool.Despawn");
            
            if (instance == null)
            {
                throw new ArgumentNullException(nameof(instance));
            }
            
            if (!_activeInstances.Remove(instance))
            {
                // Already despawned or not from this pool
                return;
            }
            
            // Notify
            instance.OnPoolDespawned();
            
            // Deactivate and reparent
            var go = instance.gameObject;
            go.SetActive(false);
            
            if (_inactiveRoot != null)
            {
                instance.transform.SetParent(_inactiveRoot, false);
            }
            
            // Get prefab name from gameObject.name (strip "(Clone)" if present)
            var name = go.name;
            if (name.EndsWith("(Clone)"))
            {
                name = name.Substring(0, name.Length - 7).TrimEnd();
            }
            
            // Add to inactive pool or destroy if over capacity
            if (!_inactiveByName.TryGetValue(name, out var queue))
            {
                queue = new Queue<T>();
                _inactiveByName[name] = queue;
            }
            
            if (queue.Count < _maxSize)
            {
                queue.Enqueue(instance);
            }
            else
            {
                _factory.DestroyInstance(instance);
            }
        }
        
        void IPool.Despawn(Component instance)
        {
            Despawn(instance as T);
        }
        
        /// <summary>
        /// Clears all inactive instances (destroys them).
        /// Active instances are not affected.
        /// </summary>
        public void Clear()
        {
            UnityMainThread.EnsureOrThrow("Pool.Clear");
            
            foreach (var kvp in _inactiveByName)
            {
                var queue = kvp.Value;
                while (queue.Count > 0)
                {
                    var instance = queue.Dequeue();
                    if (instance != null)
                    {
                        _factory.DestroyInstance(instance);
                    }
                }
            }
            _inactiveByName.Clear();
        }
    }
}
