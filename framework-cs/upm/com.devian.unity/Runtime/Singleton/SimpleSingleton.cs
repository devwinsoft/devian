// <auto-generated>
// Unity Singleton - SimpleSingleton<T>
// SSOT: skills/devian-upm/30-unity-components/01-singleton/SKILL.md
// </auto-generated>

using System;
#if UNITY_EDITOR || DEVELOPMENT_BUILD
using System.Diagnostics;
using System.Reflection;
#endif

namespace Devian
{
    /// <summary>
    /// Pure C# singleton base using Lazy&lt;T&gt;.
    /// Thread-safe and simple.
    /// No Unity/MonoBehaviour dependency.
    /// </summary>
    /// <typeparam name="T">Concrete singleton type</typeparam>
    public abstract class SimpleSingleton<T>
        where T : SimpleSingleton<T>, new()
    {
        private static readonly Lazy<T> _instance = new(() =>
        {
#if UNITY_EDITOR || DEVELOPMENT_BUILD
            _EnsureNotInCtorOrStaticInit();
#endif
            return new T();
        }, isThreadSafe: true);

        /// <summary>
        /// Gets the singleton instance. Created on first access.
        /// </summary>
        public static T Instance => _instance.Value;

        /// <summary>
        /// Protected constructor to prevent external instantiation.
        /// </summary>
        protected SimpleSingleton() { }

#if UNITY_EDITOR || DEVELOPMENT_BUILD
        /// <summary>
        /// Guard: Detects ctor/static init access patterns to avoid Unity Editor ScriptableSingleton issues.
        /// Only runs once during first Instance access (inside Lazy lambda).
        /// </summary>
        private static void _EnsureNotInCtorOrStaticInit()
        {
            var st = new StackTrace(fNeedFileInfo: true);
            var frames = st.GetFrames();
            if (frames == null) return;

            foreach (var frame in frames)
            {
                var method = frame.GetMethod();
                if (method == null) continue;

                // constructor
                if (method is ConstructorInfo)
                {
                    throw new InvalidOperationException(
                        "Do not query SimpleSingleton.Instance from constructors or static initializers. " +
                        "Use delayed initialization (EditorApplication.delayCall) or explicit Init().");
                }

                // static constructor
                if (method.IsStatic && method.Name == ".cctor")
                {
                    throw new InvalidOperationException(
                        "Do not query SimpleSingleton.Instance from constructors or static initializers. " +
                        "Use delayed initialization (EditorApplication.delayCall) or explicit Init().");
                }
            }
        }
#endif
    }
}
