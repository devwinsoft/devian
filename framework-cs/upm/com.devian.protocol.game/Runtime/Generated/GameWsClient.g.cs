// <auto-generated>
// DO NOT EDIT - Generated by Devian Build System v10
// GameWsClient: WebSocket client binding for Game protocol group.
// 
// Usage:
//   var client = new GameWsClient();
//   client.Connect("wss://...");
//   // Implement handlers via partial class
//   // Send messages via client.C2GameProxy.SendXxx(...)
//   // Call client.Tick() each frame (or register with NetTickRunner)
// </auto-generated>

#nullable enable

using System;
using Devian;

namespace Devian.Protocol.Game
{
    /// <summary>
    /// WebSocket client for Game protocol group.
    /// Implements INetTickable for unified tick management.
    /// </summary>
    public sealed class GameWsClient : INetTickable, IDisposable
    {
        // ======== Inbound Handlers ========
        public Game2C_Handlers Game2CHandlers { get; }

        // ======== Outbound Proxies ========
        public C2Game.Proxy C2GameProxy { get; }

        // ======== Core Infrastructure ========
        public NetClient Core { get; }
        public NetWsClient Transport { get; }

        // ======== Sender Adapters ========
        private sealed class C2Game_WsSender : C2Game.ISender
        {
            private readonly GameWsClient _owner;
            public C2Game_WsSender(GameWsClient owner) => _owner = owner;
            public void SendTo(int sessionId, ReadOnlySpan<byte> frame) => _owner.Transport.SendFrame(frame);
        }

        // ======== Runtime Multiplexer ========
        private sealed class RuntimeMux : INetRuntime
        {
            private readonly Game2C.Runtime _game2CRuntime;

            public RuntimeMux(
                Game2C.Runtime game2CRuntime
            )
            {
                _game2CRuntime = game2CRuntime;
            }

            public bool TryDispatchInbound(int sessionId, int opcode, ReadOnlySpan<byte> payload)
            {
                if (_game2CRuntime.TryDispatchInbound(sessionId, opcode, payload)) return true;
                return false;
            }
        }

        // ======== Constructor ========
        public GameWsClient()
        {
            // Create handlers
            Game2CHandlers = new Game2C_Handlers();

            // Create runtime multiplexer
            var runtimeMux = new RuntimeMux(
                new Game2C.Runtime(Game2CHandlers)
            );

            // Create core and transport
            Core = new NetClient(runtimeMux);
            Transport = new NetWsClient(Core);

            // Create proxies
            C2GameProxy = new C2Game.Proxy(new C2Game_WsSender(this));
        }

        // ======== Public API ========
        public bool IsConnected => Transport.IsOpen;

        public void Connect(string url, string[]? subProtocols = null) => Transport.Connect(url, subProtocols);

        public void Close() => Transport.Close();

        public void Tick() => Transport.Tick();

        public void Dispose() => Transport.Dispose();

        // ======== Events ========
        public event Action? OnOpen
        {
            add => Transport.OnOpen += value;
            remove => Transport.OnOpen -= value;
        }

        public event Action<ushort, string>? OnClose
        {
            add => Transport.OnClose += value;
            remove => Transport.OnClose -= value;
        }

        public event Action<Exception>? OnError
        {
            add => Transport.OnError += value;
            remove => Transport.OnError -= value;
        }
    }
}