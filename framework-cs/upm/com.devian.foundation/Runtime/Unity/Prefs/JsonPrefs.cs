// <auto-generated>
// Unity Prefs - JsonPrefs (class JSON 1-key)
// SSOT: skills/devian-unity/10-base-system/24-player-prefs/SKILL.md
// </auto-generated>

using System;
using UnityEngine;

namespace Devian
{
    /// <summary>
    /// PlayerPrefs wrapper for class objects stored as JSON string.
    /// Uses FromJsonOverwrite for partial field updates (new fields get default values).
    /// If parsing fails, resets to default and saves.
    ///
    /// Limitations: Follows Unity JsonUtility restrictions (no Dictionary, etc.)
    /// </summary>
    /// <typeparam name="T">The class type (must have parameterless constructor)</typeparam>
    public sealed class JsonPrefs<T> where T : class, new()
    {
        private readonly string key;
        private readonly T defaultValue;

        private T cached;
        private bool loaded;

        public JsonPrefs(string key, T defaultValue = null)
        {
            this.key = key;
            this.defaultValue = defaultValue ?? new T();
        }

        /// <summary>
        /// Gets the cached value. Loads from PlayerPrefs on first access.
        /// </summary>
        public T Value
        {
            get
            {
                _EnsureLoaded();
                return cached;
            }
        }

        /// <summary>
        /// Edits the value using a mutator action and optionally saves immediately.
        /// </summary>
        /// <param name="mutator">Action to modify the cached value</param>
        /// <param name="saveNow">If true, calls PlayerPrefs.Save() immediately</param>
        public void Edit(Action<T> mutator, bool saveNow = true)
        {
            _EnsureLoaded();
            mutator?.Invoke(cached);
            Save(saveNow);
        }

        /// <summary>
        /// Saves the cached value to PlayerPrefs.
        /// </summary>
        /// <param name="saveNow">If true, calls PlayerPrefs.Save() immediately</param>
        public void Save(bool saveNow = false)
        {
            _EnsureLoaded();

            var json = JsonUtility.ToJson(cached);
            PlayerPrefs.SetString(key, json);

            if (saveNow) PlayerPrefs.Save();
        }

        /// <summary>
        /// Deletes the key from PlayerPrefs and resets cached state.
        /// </summary>
        public void Delete()
        {
            PlayerPrefs.DeleteKey(key);
            loaded = false;
            cached = null;
        }

        private void _EnsureLoaded()
        {
            if (loaded) return;

            cached = _CloneDefault();
            loaded = true;

            if (!PlayerPrefs.HasKey(key))
            {
                PlayerPrefs.SetString(key, JsonUtility.ToJson(cached));
                return;
            }

            var json = PlayerPrefs.GetString(key, string.Empty);
            if (string.IsNullOrEmpty(json))
            {
                PlayerPrefs.SetString(key, JsonUtility.ToJson(cached));
                return;
            }

            try
            {
                JsonUtility.FromJsonOverwrite(json, cached);
            }
            catch
            {
                // Parse failed, reset to default
                PlayerPrefs.SetString(key, JsonUtility.ToJson(cached));
            }
        }

        private T _CloneDefault()
        {
            try
            {
                var json = JsonUtility.ToJson(defaultValue);
                var obj = new T();
                JsonUtility.FromJsonOverwrite(json, obj);
                return obj;
            }
            catch
            {
                return new T();
            }
        }
    }
}
